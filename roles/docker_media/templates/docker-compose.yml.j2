# {{ ansible_managed }}

version: "3.6"
services:
  vpn:
    container_name: open-vpn
    image: dperson/openvpn-client
    cap_add:
      - net_admin
    environment:
      - TZ='EST5EDT'
    networks:
      - default
    ports:
      - 6881:6881 #qBittorrent
      - 6881:6881/udp #qBittorrent
      - 8080:8080 #qBittorrent UI
    read_only: false
    tmpfs:
      - /run
      - /tmp
    restart: unless-stopped
    security_opt:
      - label:disable
    stdin_open: true
    tty: true
    volumes:
      - /dev/net:/dev/net:z
      - {{ docker_media_docker_storage }}/openvpn:/vpn
    command: -f "" -d -r "{{ docker_media_lan_cidr }}"
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent
    container_name: qbittorrent
    environment:
      - PUID={{ docker_uid }}
      - PGID={{ docker_gid }}
      - TZ='EST5EDT'
    volumes:
      - {{ docker_media_docker_storage }}/qbittorrent:/config
      - {{ docker_media_staging_path }}:/downloads
    network_mode: "service:vpn"
    restart: unless-stopped
    labels: 
      - autoheal=true
    healthcheck:
      test: curl -fSs https://google.com || exit 1
      start_period: 15s
      timeout: 10s
      interval: 5s
      retries: 3
  prowlarr: #index aggregator
    container_name: prowlarr
    image: linuxserver/prowlarr:nightly
    networks:
      - default
    environment:
      - PUID={{ docker_uid }}
      - PGID={{ docker_gid }}
      - TZ='EST5EDT'
    volumes:
      - {{ docker_media_docker_storage }}/prowlarr:/config
    ports:
      - 9696:9696 
    labels: 
      - autoheal=true
    healthcheck:
      test: curl -fSs http://127.0.0.1:9696 > /dev/null || exit 1
      start_period: 20s
      timeout: 5s
      interval: 5s
      retries: 3    
    restart: unless-stopped
    depends_on:
  #     #sabnzbd:
  #     #  condition: service_healthy
      qbittorrent:
        condition: service_healthy
networks:
  default:
